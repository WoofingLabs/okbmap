<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKB Map</title>
    <link rel="icon" href="https://woofingjace.com/images/jace.png" type="image/x-icon">
    <style>
        body { background: #000000; font-family: Arial, sans-serif; margin: 0; padding: 20px; color: #ffffff; }
        .container { max-width: 600px; margin: 0 auto; background: #1a1a1a; padding: 20px; border-radius: 8px; }
        h1 { text-align: center; font-size: 24px; margin-bottom: 20px; }
        .section { margin-bottom: 20px; }
        label { display: block; margin-bottom: 5px; font-size: 14px; }
        select { width: 100%; height: 30px; padding: 0 5px; border: 1px solid #444444; background: #2d2d2d; color: #ffffff; border-radius: 4px; appearance: none; cursor: pointer; }
        select option { background: #2d2d2d; color: #ffffff; }
        input[type="text"] { width: 100%; padding: 8px; margin-bottom: 10px; background: #2d2d2d; border: 1px solid #444444; color: #ffffff; border-radius: 4px; }
        button { background: #333333; color: #ffffff; padding: 8px 12px; border: none; border-radius: 4px; cursor: pointer; margin-right: 5px; }
        button:hover { background: #444444; }
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .control-group { display: flex; flex-direction: column; align-items: flex-start; }
        .status { margin-top: 10px; font-size: 14px; text-align: center; }
        .disabled { opacity: 0.5; pointer-events: none; }
        #gridCanvas { width: 100%; max-width: 300px; height: 300px; display: block; margin: 0 auto 20px; border: 1px solid #444444; border-radius: 4px; }
        .action-buttons { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .nft-viewer { margin-top: 20px; }
        .nft-viewer h2 { font-size: 18px; text-align: center; margin-bottom: 10px; }
        #nftList { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .nft-card { background: #2d2d2d; padding: 10px; border-radius: 4px; text-align: center; }
        .nft-card img { width: 100%; max-width: 120px; height: auto; border-radius: 4px; }
        .nft-card p { font-size: 12px; margin: 5px 0; }
    </style>
</head>
<body>
    <div class="container">
        <h1>OKB Map</h1>
        <div class="section">
            <button id="connectWallet" class="button">连接钱包</button>
            <div id="walletStatus" class="status">未连接</div>
        </div>
        <div class="section">
            <canvas id="gridCanvas" width="300" height="300"></canvas>
            <div class="controls">
                <div class="control-group">
                    <label for="centerColor">中心颜色 (3,3)</label>
                    <select id="centerColor" disabled>
                        <option value="#FF0000">红色</option>
                        <option value="#00FF00">绿色</option>
                        <option value="#0000FF">蓝色</option>
                        <option value="#FFFF00">黄色</option>
                        <option value="#FF00FF">品红</option>
                        <option value="#00FFFF">青色</option>
                        <option value="#FFFFFF">白色</option>
                        <option value="#000000">黑色</option>
                        <option value="#FF4500">橙红色</option>
                        <option value="#FFA500">橙色</option>
                        <option value="#FFD700">金色</option>
                        <option value="#ADFF2F">绿黄色</option>
                        <option value="#9ACD32">橄榄绿</option>
                        <option value="#32CD32">闪光绿</option>
                        <option value="#228B22">森林绿</option>
                        <option value="#4169E1">皇家蓝</option>
                        <option value="#1E90FF">闪电蓝</option>
                        <option value="#00B7EB">深天蓝</option>
                        <option value="#6A5ACD">石板蓝</option>
                        <option value="#8A2BE2">蓝紫</option>
                        <option value="#9370DB">中紫</option>
                        <option value="#DDA0DD">李子色</option>
                        <option value="#FF69B4">热情粉</option>
                        <option value="#FF1493">深粉</option>
                        <option value="#C71585">中紫红</option>
                        <option value="#CD5C5C">印度红</option>
                        <option value="#DC143C">猩红</option>
                        <option value="#B22222">耐火砖红</option>
                        <option value="#F4A460">沙棕</option>
                        <option value="#D2691E">巧克力色</option>
                        <option value="#8B4513">鞍棕</option>
                        <option value="#A52A2A">棕色</option>
                        <option value="#DEB887">硬木色</option>
                        <option value="#D2B48C">棕褐色</option>
                        <option value="#F0E68C">卡其色</option>
                        <option value="#98FB98">浅绿</option>
                        <option value="#AFEEEE">浅青</option>
                        <option value="#87CEEB">天空蓝</option>
                        <option value="#E6E6FA">淡紫</option>
                        <option value="#FFB6C1">浅粉</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="corner1Color">左上角颜色 (2,2)</label>
                    <select id="corner1Color" disabled>
                        <option value="#FF0000">红色</option>
                        <option value="#00FF00">绿色</option>
                        <option value="#0000FF">蓝色</option>
                        <option value="#FFFF00">黄色</option>
                        <option value="#FF00FF">品红</option>
                        <option value="#00FFFF">青色</option>
                        <option value="#FFFFFF">白色</option>
                        <option value="#000000">黑色</option>
                        <option value="#FF4500">橙红色</option>
                        <option value="#FFA500">橙色</option>
                        <option value="#FFD700">金色</option>
                        <option value="#ADFF2F">绿黄色</option>
                        <option value="#9ACD32">橄榄绿</option>
                        <option value="#32CD32">闪光绿</option>
                        <option value="#228B22">森林绿</option>
                        <option value="#4169E1">皇家蓝</option>
                        <option value="#1E90FF">闪电蓝</option>
                        <option value="#00B7EB">深天蓝</option>
                        <option value="#6A5ACD">石板蓝</option>
                        <option value="#8A2BE2">蓝紫</option>
                        <option value="#9370DB">中紫</option>
                        <option value="#DDA0DD">李子色</option>
                        <option value="#FF69B4">热情粉</option>
                        <option value="#FF1493">深粉</option>
                        <option value="#C71585">中紫红</option>
                        <option value="#CD5C5C">印度红</option>
                        <option value="#DC143C">猩红</option>
                        <option value="#B22222">耐火砖红</option>
                        <option value="#F4A460">沙棕</option>
                        <option value="#D2691E">巧克力色</option>
                        <option value="#8B4513">鞍棕</option>
                        <option value="#A52A2A">棕色</option>
                        <option value="#DEB887">硬木色</option>
                        <option value="#D2B48C">棕褐色</option>
                        <option value="#F0E68C">卡其色</option>
                        <option value="#98FB98">浅绿</option>
                        <option value="#AFEEEE">浅青</option>
                        <option value="#87CEEB">天空蓝</option>
                        <option value="#E6E6FA">淡紫</option>
                        <option value="#FFB6C1">浅粉</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="corner2Color">右上角颜色 (2,4)</label>
                    <select id="corner2Color" disabled>
                        <option value="#FF0000">红色</option>
                        <option value="#00FF00">绿色</option>
                        <option value="#0000FF">蓝色</option>
                        <option value="#FFFF00">黄色</option>
                        <option value="#FF00FF">品红</option>
                        <option value="#00FFFF">青色</option>
                        <option value="#FFFFFF">白色</option>
                        <option value="#000000">黑色</option>
                        <option value="#FF4500">橙红色</option>
                        <option value="#FFA500">橙色</option>
                        <option value="#FFD700">金色</option>
                        <option value="#ADFF2F">绿黄色</option>
                        <option value="#9ACD32">橄榄绿</option>
                        <option value="#32CD32">闪光绿</option>
                        <option value="#228B22">森林绿</option>
                        <option value="#4169E1">皇家蓝</option>
                        <option value="#1E90FF">闪电蓝</option>
                        <option value="#00B7EB">深天蓝</option>
                        <option value="#6A5ACD">石板蓝</option>
                        <option value="#8A2BE2">蓝紫</option>
                        <option value="#9370DB">中紫</option>
                        <option value="#DDA0DD">李子色</option>
                        <option value="#FF69B4">热情粉</option>
                        <option value="#FF1493">深粉</option>
                        <option value="#C71585">中紫红</option>
                        <option value="#CD5C5C">印度红</option>
                        <option value="#DC143C">猩红</option>
                        <option value="#B22222">耐火砖红</option>
                        <option value="#F4A460">沙棕</option>
                        <option value="#D2691E">巧克力色</option>
                        <option value="#8B4513">鞍棕</option>
                        <option value="#A52A2A">棕色</option>
                        <option value="#DEB887">硬木色</option>
                        <option value="#D2B48C">棕褐色</option>
                        <option value="#F0E68C">卡其色</option>
                        <option value="#98FB98">浅绿</option>
                        <option value="#AFEEEE">浅青</option>
                        <option value="#87CEEB">天空蓝</option>
                        <option value="#E6E6FA">淡紫</option>
                        <option value="#FFB6C1">浅粉</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="corner3Color">左下角颜色 (4,2)</label>
                    <select id="corner3Color" disabled>
                        <option value="#FF0000">红色</option>
                        <option value="#00FF00">绿色</option>
                        <option value="#0000FF">蓝色</option>
                        <option value="#FFFF00">黄色</option>
                        <option value="#FF00FF">品红</option>
                        <option value="#00FFFF">青色</option>
                        <option value="#FFFFFF">白色</option>
                        <option value="#000000">黑色</option>
                        <option value="#FF4500">橙红色</option>
                        <option value="#FFA500">橙色</option>
                        <option value="#FFD700">金色</option>
                        <option value="#ADFF2F">绿黄色</option>
                        <option value="#9ACD32">橄榄绿</option>
                        <option value="#32CD32">闪光绿</option>
                        <option value="#228B22">森林绿</option>
                        <option value="#4169E1">皇家蓝</option>
                        <option value="#1E90FF">闪电蓝</option>
                        <option value="#00B7EB">深天蓝</option>
                        <option value="#6A5ACD">石板蓝</option>
                        <option value="#8A2BE2">蓝紫</option>
                        <option value="#9370DB">中紫</option>
                        <option value="#DDA0DD">李子色</option>
                        <option value="#FF69B4">热情粉</option>
                        <option value="#FF1493">深粉</option>
                        <option value="#C71585">中紫红</option>
                        <option value="#CD5C5C">印度红</option>
                        <option value="#DC143C">猩红</option>
                        <option value="#B22222">耐火砖红</option>
                        <option value="#F4A460">沙棕</option>
                        <option value="#D2691E">巧克力色</option>
                        <option value="#8B4513">鞍棕</option>
                        <option value="#A52A2A">棕色</option>
                        <option value="#DEB887">硬木色</option>
                        <option value="#D2B48C">棕褐色</option>
                        <option value="#F0E68C">卡其色</option>
                        <option value="#98FB98">浅绿</option>
                        <option value="#AFEEEE">浅青</option>
                        <option value="#87CEEB">天空蓝</option>
                        <option value="#E6E6FA">淡紫</option>
                        <option value="#FFB6C1">浅粉</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="corner4Color">右下角颜色 (4,4)</label>
                    <select id="corner4Color" disabled>
                        <option value="#FF0000">红色</option>
                        <option value="#00FF00">绿色</option>
                        <option value="#0000FF">蓝色</option>
                        <option value="#FFFF00">黄色</option>
                        <option value="#FF00FF">品红</option>
                        <option value="#00FFFF">青色</option>
                        <option value="#FFFFFF">白色</option>
                        <option value="#000000">黑色</option>
                        <option value="#FF4500">橙红色</option>
                        <option value="#FFA500">橙色</option>
                        <option value="#FFD700">金色</option>
                        <option value="#ADFF2F">绿黄色</option>
                        <option value="#9ACD32">橄榄绿</option>
                        <option value="#32CD32">闪光绿</option>
                        <option value="#228B22">森林绿</option>
                        <option value="#4169E1">皇家蓝</option>
                        <option value="#1E90FF">闪电蓝</option>
                        <option value="#00B7EB">深天蓝</option>
                        <option value="#6A5ACD">石板蓝</option>
                        <option value="#8A2BE2">蓝紫</option>
                        <option value="#9370DB">中紫</option>
                        <option value="#DDA0DD">李子色</option>
                        <option value="#FF69B4">热情粉</option>
                        <option value="#FF1493">深粉</option>
                        <option value="#C71585">中紫红</option>
                        <option value="#CD5C5C">印度红</option>
                        <option value="#DC143C">猩红</option>
                        <option value="#B22222">耐火砖红</option>
                        <option value="#F4A460">沙棕</option>
                        <option value="#D2691E">巧克力色</option>
                        <option value="#8B4513">鞍棕</option>
                        <option value="#A52A2A">棕色</option>
                        <option value="#DEB887">硬木色</option>
                        <option value="#D2B48C">棕褐色</option>
                        <option value="#F0E68C">卡其色</option>
                        <option value="#98FB98">浅绿</option>
                        <option value="#AFEEEE">浅青</option>
                        <option value="#87CEEB">天空蓝</option>
                        <option value="#E6E6FA">淡紫</option>
                        <option value="#FFB6C1">浅粉</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="defaultColor">默认颜色</label>
                    <select id="defaultColor" disabled>
                        <option value="#FF0000">红色</option>
                        <option value="#00FF00">绿色</option>
                        <option value="#0000FF">蓝色</option>
                        <option value="#FFFF00">黄色</option>
                        <option value="#FF00FF">品红</option>
                        <option value="#00FFFF">青色</option>
                        <option value="#FFFFFF">白色</option>
                        <option value="#000000">黑色</option>
                        <option value="#FF4500">橙红色</option>
                        <option value="#FFA500">橙色</option>
                        <option value="#FFD700">金色</option>
                        <option value="#ADFF2F">绿黄色</option>
                        <option value="#9ACD32">橄榄绿</option>
                        <option value="#32CD32">闪光绿</option>
                        <option value="#228B22">森林绿</option>
                        <option value="#4169E1">皇家蓝</option>
                        <option value="#1E90FF">闪电蓝</option>
                        <option value="#00B7EB">深天蓝</option>
                        <option value="#6A5ACD">石板蓝</option>
                        <option value="#8A2BE2">蓝紫</option>
                        <option value="#9370DB">中紫</option>
                        <option value="#DDA0DD">李子色</option>
                        <option value="#FF69B4">热情粉</option>
                        <option value="#FF1493">深粉</option>
                        <option value="#C71585">中紫红</option>
                        <option value="#CD5C5C">印度红</option>
                        <option value="#DC143C">猩红</option>
                        <option value="#B22222">耐火砖红</option>
                        <option value="#F4A460">沙棕</option>
                        <option value="#D2691E">巧克力色</option>
                        <option value="#8B4513">鞍棕</option>
                        <option value="#A52A2A">棕色</option>
                        <option value="#DEB887">硬木色</option>
                        <option value="#D2B48C">棕褐色</option>
                        <option value="#F0E68C">卡其色</option>
                        <option value="#98FB98">浅绿</option>
                        <option value="#AFEEEE">浅青</option>
                        <option value="#87CEEB">天空蓝</option>
                        <option value="#E6E6FA">淡紫</option>
                        <option value="#FFB6C1">浅粉</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="borderColor">边框颜色</label>
                    <select id="borderColor" disabled>
                        <option value="#FF0000">红色</option>
                        <option value="#00FF00">绿色</option>
                        <option value="#0000FF">蓝色</option>
                        <option value="#FFFF00">黄色</option>
                        <option value="#FF00FF">品红</option>
                        <option value="#00FFFF">青色</option>
                        <option value="#FFFFFF">白色</option>
                        <option value="#000000">黑色</option>
                        <option value="#FF4500">橙红色</option>
                        <option value="#FFA500">橙色</option>
                        <option value="#FFD700">金色</option>
                        <option value="#ADFF2F">绿黄色</option>
                        <option value="#9ACD32">橄榄绿</option>
                        <option value="#32CD32">闪光绿</option>
                        <option value="#228B22">森林绿</option>
                        <option value="#4169E1">皇家蓝</option>
                        <option value="#1E90FF">闪电蓝</option>
                        <option value="#00B7EB">深天蓝</option>
                        <option value="#6A5ACD">石板蓝</option>
                        <option value="#8A2BE2">蓝紫</option>
                        <option value="#9370DB">中紫</option>
                        <option value="#DDA0DD">李子色</option>
                        <option value="#FF69B4">热情粉</option>
                        <option value="#FF1493">深粉</option>
                        <option value="#C71585">中紫红</option>
                        <option value="#CD5C5C">印度红</option>
                        <option value="#DC143C">猩红</option>
                        <option value="#B22222">耐火砖红</option>
                        <option value="#F4A460">沙棕</option>
                        <option value="#D2691E">巧克力色</option>
                        <option value="#8B4513">鞍棕</option>
                        <option value="#A52A2A">棕色</option>
                        <option value="#DEB887">硬木色</option>
                        <option value="#D2B48C">棕褐色</option>
                        <option value="#F0E68C">卡其色</option>
                        <option value="#98FB98">浅绿</option>
                        <option value="#AFEEEE">浅青</option>
                        <option value="#87CEEB">天空蓝</option>
                        <option value="#E6E6FA">淡紫</option>
                        <option value="#FFB6C1">浅粉</option>
                    </select>
                </div>
            </div>
            <div class="action-buttons">
                <button id="randomizeBtn" onclick="randomizeColors()" disabled>随机颜色</button>
                <button id="downloadBtn" onclick="downloadGrid()" disabled>下载图片</button>
                <button id="mintBtn" onclick="mintNFT()" disabled>铸造NFT (0.1 OKB)</button>
            </div>
            <div id="transactionStatus" class="status"></div>
        </div>
        <div class="nft-viewer">
            <h2>你的 OKB Map NFT</h2>
            <div id="nftList"></div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.7.0/dist/web3.min.js"></script>
    <script>
        let web3, accounts, contract;
        const CONTRACT_ADDRESS = '0x2C3568EA818D06929907de160EB6EDFa002d18a0';
        const MINT_PRICE = '100000000000000000';

        const CONTRACT_ABI = [
            {
                "inputs": [
                    {"internalType": "string", "name": "uri", "type": "string"},
                    {"internalType": "string[]", "name": "attributes", "type": "string[]"}
                ],
                "name": "mintNFT",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "address", "name": "_owner", "type": "address"}
                ],
                "name": "walletOfOwner",
                "outputs": [
                    {"internalType": "uint256[]", "name": "", "type": "uint256[]"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "uint256", "name": "tokenId", "type": "uint256"}
                ],
                "name": "tokenURI",
                "outputs": [
                    {"internalType": "string", "name": "", "type": "string"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "uint256", "name": "tokenId", "type": "uint256"},
                    {"internalType": "string", "name": "newTokenURI", "type": "string"}
                ],
                "name": "updateTokenMetadata",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "uint256", "name": "_newCost", "type": "uint256"}
                ],
                "name": "setCost",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "withdraw",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "inputs": [
                    {"internalType": "address", "name": "to", "type": "address"},
                    {"internalType": "uint256", "name": "tokenId", "type": "uint256"},
                    {"internalType": "string", "name": "uri", "type": "string"},
                    {"internalType": "bytes32", "name": "attributes", "type": "bytes32"}
                ],
                "name": "ownerMintWithData",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "totalSupply",
                "outputs": [
                    {"internalType": "uint256", "name": "", "type": "uint256"}
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        const xLayerMainnet = {
            chainId: '0xc4',
            chainName: 'xLayer',
            nativeCurrency: {
                name: 'OKB',
                symbol: 'OKB',
                decimals: 18
            },
            rpcUrls: ['https://rpc.xlayer.tech'],
            blockExplorerUrls: ['https://www.okx.com/explorer/xlayer']
        };

        function showStatus(message) {
            document.getElementById('transactionStatus').innerText = message;
        }

        async function connectWallet() {
            if (!window.ethereum) {
                showStatus('请安装 MetaMask。');
                return;
            }
            try {
                web3 = new Web3(window.ethereum);
                accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                if (chainId !== '0xc4') {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0xc4' }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [xLayerMainnet],
                            });
                        } else {
                            throw switchError;
                        }
                    }
                }
                contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);
                showStatus(`已连接: ${accounts[0].slice(0, 6)}...${accounts[0].slice(-4)}`);
                enableInputs(true);
                fetchOwnedNFTs();
            } catch (error) {
                showStatus('连接失败: ' + error.message);
            }
        }

        function enableInputs(enabled) {
            document.getElementById('centerColor').disabled = !enabled;
            document.getElementById('corner1Color').disabled = !enabled;
            document.getElementById('corner2Color').disabled = !enabled;
            document.getElementById('corner3Color').disabled = !enabled;
            document.getElementById('corner4Color').disabled = !enabled;
            document.getElementById('defaultColor').disabled = !enabled;
            document.getElementById('borderColor').disabled = !enabled;
            document.getElementById('randomizeBtn').disabled = !enabled;
            document.getElementById('downloadBtn').disabled = !enabled;
            document.getElementById('mintBtn').disabled = !enabled;
        }

        const canvas = document.getElementById('gridCanvas');
        const ctx = canvas.getContext('2d');
        const gridSize = 5;
        const cellSize = canvas.width / gridSize;

        const colors = {
            center: '#FF0000',
            corner1: '#00FF00',
            corner2: '#0000FF',
            corner3: '#FFFF00',
            corner4: '#FFFFFF',
            default: '#000000',
            border: '#FF0000'
        };

        const colorOptions = [
            '#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF',
            '#00FFFF', '#FFFFFF', '#000000', '#FF4500', '#FFA500',
            '#FFD700', '#ADFF2F', '#9ACD32', '#32CD32', '#228B22',
            '#4169E1', '#1E90FF', '#00B7EB', '#6A5ACD', '#8A2BE2',
            '#9370DB', '#DDA0DD', '#FF69B4', '#FF1493', '#C71585',
            '#CD5C5C', '#DC143C', '#B22222', '#F4A460', '#D2691E',
            '#8B4513', '#A52A2A', '#DEB887', '#D2B48C', '#F0E68C',
            '#98FB98', '#AFEEEE', '#87CEEB', '#E6E6FA', '#FFB6C1'
        ];

        const colorNames = [
            'Red', 'Green', 'Blue', 'Yellow', 'Magenta',
            'Cyan', 'White', 'Black', 'OrangeRed', 'Orange',
            'Gold', 'YellowGreen', 'Olive', 'LimeGreen', 'ForestGreen',
            'RoyalBlue', 'DodgerBlue', 'DeepSkyBlue', 'SlateBlue', 'BlueViolet',
            'MediumPurple', 'Plum', 'HotPink', 'DeepPink', 'MediumVioletRed',
            'IndianRed', 'Crimson', 'FireBrick', 'SandyBrown', 'Chocolate',
            'SaddleBrown', 'Brown', 'BurlyWood', 'Tan', 'Khaki',
            'PaleGreen', 'PaleTurquoise', 'SkyBlue', 'Lavender', 'LightPink'
        ];

        function drawGrid() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let row = 1; row <= gridSize; row++) {
                for (let col = 1; col <= gridSize; col++) {
                    let fillColor = colors.default;
                    if (row === 3 && col === 3) fillColor = colors.center;
                    else if (row === 2 && col === 2) fillColor = colors.corner1;
                    else if (row === 2 && col === 4) fillColor = colors.corner2;
                    else if (row === 4 && col === 2) fillColor = colors.corner3;
                    else if (row === 4 && col === 4) fillColor = colors.corner4;
                    ctx.fillStyle = fillColor;
                    ctx.fillRect((col - 1) * cellSize, (row - 1) * cellSize, cellSize, cellSize);
                }
            }
            if (colors.border) {
                ctx.strokeStyle = colors.border;
                ctx.lineWidth = 1;
                ctx.strokeRect(0, 0, canvas.width, canvas.height);
            }
        }

        function randomizeColors() {
            let newColors = {};
            const usedColors = new Set();

            newColors.default = colorOptions[Math.floor(Math.random() * colorOptions.length)];
            usedColors.add(newColors.default);

            let availableColors = colorOptions.filter(color => !usedColors.has(color));
            if (availableColors.length < 5) {
                alert('可用颜色不足，请重试或调整默认颜色。');
                return;
            }

            newColors.center = availableColors[Math.floor(Math.random() * availableColors.length)];
            usedColors.add(newColors.center);
            availableColors = availableColors.filter(color => !usedColors.has(color));

            newColors.corner1 = availableColors[Math.floor(Math.random() * availableColors.length)];
            usedColors.add(newColors.corner1);
            availableColors = availableColors.filter(color => !usedColors.has(color));

            newColors.corner2 = availableColors[Math.floor(Math.random() * availableColors.length)];
            usedColors.add(newColors.corner2);
            availableColors = availableColors.filter(color => !usedColors.has(color));

            newColors.corner3 = availableColors[Math.floor(Math.random() * availableColors.length)];
            usedColors.add(newColors.corner3);
            availableColors = availableColors.filter(color => !usedColors.has(color));

            newColors.corner4 = availableColors.length > 0 ? availableColors[Math.floor(Math.random() * availableColors.length)] : colorOptions[Math.floor(Math.random() * colorOptions.length)];
            if (newColors.corner4 === newColors.default) {
                newColors.corner4 = colorOptions.find(color => !usedColors.has(color) && color !== newColors.default) || '#808080';
            }

            newColors.border = colorOptions[Math.floor(Math.random() * colorOptions.length)];

            colors.center = newColors.center;
            colors.corner1 = newColors.corner1;
            colors.corner2 = newColors.corner2;
            colors.corner3 = newColors.corner3;
            colors.corner4 = newColors.corner4;
            colors.default = newColors.default;
            colors.border = newColors.border;

            document.getElementById('centerColor').value = colors.center;
            document.getElementById('corner1Color').value = colors.corner1;
            document.getElementById('corner2Color').value = colors.corner2;
            document.getElementById('corner3Color').value = colors.corner3;
            document.getElementById('corner4Color').value = colors.corner4;
            document.getElementById('defaultColor').value = colors.default;
            document.getElementById('borderColor').value = colors.border;

            drawGrid();
            checkColorConflict();
        }

        function downloadGrid() {
            const link = document.createElement('a');
            link.download = 'okb-map-grid.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        document.getElementById('centerColor').addEventListener('change', () => {
            colors.center = document.getElementById('centerColor').value;
            drawGrid();
            checkColorConflict();
        });
        document.getElementById('corner1Color').addEventListener('change', () => {
            colors.corner1 = document.getElementById('corner1Color').value;
            drawGrid();
            checkColorConflict();
        });
        document.getElementById('corner2Color').addEventListener('change', () => {
            colors.corner2 = document.getElementById('corner2Color').value;
            drawGrid();
            checkColorConflict();
        });
        document.getElementById('corner3Color').addEventListener('change', () => {
            colors.corner3 = document.getElementById('corner3Color').value;
            drawGrid();
            checkColorConflict();
        });
        document.getElementById('corner4Color').addEventListener('change', () => {
            colors.corner4 = document.getElementById('corner4Color').value;
            drawGrid();
            checkColorConflict();
        });
        document.getElementById('defaultColor').addEventListener('change', () => {
            colors.default = document.getElementById('defaultColor').value;
            drawGrid();
            checkColorConflict();
        });
        document.getElementById('borderColor').addEventListener('change', () => {
            colors.border = document.getElementById('borderColor').value;
            drawGrid();
        });

        function checkColorConflict() {
            const customColors = [colors.center, colors.corner1, colors.corner2, colors.corner3, colors.corner4];
            if (customColors.includes(colors.default)) {
                showStatus('5个格子的颜色不能与默认颜色相同，请调整！');
                document.getElementById('mintBtn').disabled = true;
            } else {
                showStatus('');
                document.getElementById('mintBtn').disabled = false;
            }
        }

async function mintNFT() {
    if (!web3 || !contract || !accounts) {
        showStatus('请先连接钱包。');
        return;
    }
    const mintButton = document.getElementById('mintBtn');
    mintButton.disabled = true;
    try {
        const balance = await web3.eth.getBalance(accounts[0]);
        if (web3.utils.toWei(balance, 'wei') < MINT_PRICE) {
            showStatus('钱包余额不足，请充值！');
            return;
        }
        showStatus('正在铸造NFT...');
        const totalSupply = await contract.methods.totalSupply().call();
        const imageData = canvas.toDataURL('image/png').split(',')[1];
        const metadata = {
            name: `OKB Map #${parseInt(totalSupply) + 1}`,
            description: 'A unique 5x5 grid NFT with customizable corners, center, and border on OKB Map',
            image: `data:image/png;base64,${imageData}`,
            attributes: [
                { trait_type: 'Center Color (3,3)', value: colors.center },
                { trait_type: 'Top-Left Corner (2,2)', value: colors.corner1 },
                { trait_type: 'Top-Right Corner (2,4)', value: colors.corner2 },
                { trait_type: 'Bottom-Left Corner (4,2)', value: colors.corner3 },
                { trait_type: 'Bottom-Right Corner (4,4)', value: colors.corner4 },
                { trait_type: 'Default Color', value: colors.default },
                { trait_type: 'Border Color', value: colors.border }
            ]
        };
        const tokenURI = `data:application/json;base64,${btoa(JSON.stringify(metadata))}`;
        const colorToName = {
            '#FF0000': 'Red', '#00FF00': 'Green', '#0000FF': 'Blue', '#FFFF00': 'Yellow',
            '#FF00FF': 'Magenta', '#00FFFF': 'Cyan', '#FFFFFF': 'White', '#000000': 'Black',
            '#FF4500': 'OrangeRed', '#FFA500': 'Orange', '#FFD700': 'Gold', '#ADFF2F': 'YellowGreen',
            '#9ACD32': 'Olive', '#32CD32': 'LimeGreen', '#228B22': 'ForestGreen', '#4169E1': 'RoyalBlue',
            '#1E90FF': 'DodgerBlue', '#00B7EB': 'DeepSkyBlue', '#6A5ACD': 'SlateBlue', '#8A2BE2': 'BlueViolet',
            '#9370DB': 'MediumPurple', '#DDA0DD': 'Plum', '#FF69B4': 'HotPink', '#FF1493': 'DeepPink',
            '#C71585': 'MediumVioletRed', '#CD5C5C': 'IndianRed', '#DC143C': 'Crimson', '#B22222': 'FireBrick',
            '#F4A460': 'SandyBrown', '#D2691E': 'Chocolate', '#8B4513': 'SaddleBrown', '#A52A2A': 'Brown',
            '#DEB887': 'BurlyWood', '#D2B48C': 'Tan', '#F0E68C': 'Khaki', '#98FB98': 'PaleGreen',
            '#AFEEEE': 'PaleTurquoise', '#87CEEB': 'SkyBlue', '#E6E6FA': 'Lavender', '#FFB6C1': 'LightPink'
        };
        const attributes = [
            `${colorToName[colors.center]}1`,
            `${colorToName[colors.corner1]}2`,
            `${colorToName[colors.corner2]}3`,
            `${colorToName[colors.corner3]}4`,
            `${colorToName[colors.corner4]}5`,
            `${colorToName[colors.default]}6`,
            `${colorToName[colors.border]}7`
        ];
        const uniqueAttributes = new Set(attributes);
        if (uniqueAttributes.size < attributes.length) {
            showStatus('铸造失败: attributes 中存在重复值，请调整颜色！');
            return;
        }

        await contract.methods.mintNFT(tokenURI, attributes).send({
            from: accounts[0],
            value: MINT_PRICE
        });
        showStatus('NFT铸造成功！');
        fetchOwnedNFTs();
    } catch (error) {
        showStatus('铸造失败: ' + error.message);
        console.error('Minting Error:', error);
        if (error.message.includes('revert')) {
            showStatus('铸造失败: 合约可能拒绝了交易，检查属性唯一性或余额。');
        } else if (error.message.includes('out of gas')) {
            showStatus('铸造失败: Gas 不足，请增加 Gas Limit。');
        }
    } finally {
        mintButton.disabled = false;
    }
}

        async function fetchOwnedNFTs() {
            if (!web3 || !contract || !accounts) {
                showStatus('请先连接钱包。');
                return;
            }
            const nftList = document.getElementById('nftList');
            nftList.innerHTML = '<p>正在加载你的NFT...</p>';
            try {
                const tokenIds = await contract.methods.walletOfOwner(accounts[0]).call();
                if (tokenIds.length === 0) {
                    nftList.innerHTML = '<p>你尚未拥有任何 OKB Map NFT。</p>';
                    return;
                }
                nftList.innerHTML = '';
                for (const tokenId of tokenIds) {
                    const tokenURI = await contract.methods.tokenURI(tokenId).call();
                    await displayNFT(tokenId, tokenURI);
                }
            } catch (error) {
                nftList.innerHTML = '<p>加载NFT失败: ' + error.message + '</p>';
            }
        }

        async function displayNFT(tokenId, tokenURI) {
            const nftList = document.getElementById('nftList');
            let metadata;
            if (tokenURI.startsWith('data:application/json;base64,')) {
                const base64Data = tokenURI.split(',')[1];
                metadata = JSON.parse(atob(base64Data));
            } else {
                metadata = { name: `OKB Map #${tokenId}`, image: 'Unknown' };
            }
            const nftDiv = document.createElement('div');
            nftDiv.className = 'nft-card';
            nftDiv.innerHTML = `
                <img src="${metadata.image}" alt="${metadata.name}">
                <p>${metadata.name} (ID: ${tokenId})</p>
                <input type="text" id="transferAddress${tokenId}" placeholder="接收地址">
                <button class="button" onclick="transferNFT(${tokenId})">转移</button>
            `;
            nftList.appendChild(nftDiv);
        }

        async function transferNFT(tokenId) {
            if (!web3 || !contract || !accounts) {
                showStatus('请先连接钱包。');
                return;
            }
            const transferAddress = document.getElementById(`transferAddress${tokenId}`).value;
            if (!web3.utils.isAddress(transferAddress)) {
                showStatus('无效的以太坊地址！');
                return;
            }
            try {
                showStatus('正在转移NFT...');
                await contract.methods.safeTransferFrom(accounts[0], transferAddress, tokenId).send({ from: accounts[0] });
                showStatus('NFT转移成功！');
                fetchOwnedNFTs();
            } catch (error) {
                showStatus('转移失败: ' + error.message);
            }
        }

        document.getElementById('connectWallet').addEventListener('click', connectWallet);
        document.getElementById('randomizeBtn').addEventListener('click', randomizeColors);
        document.getElementById('downloadBtn').addEventListener('click', downloadGrid);

        window.onload = () => {
            drawGrid();
            if (!window.ethereum) {
                showStatus('未检测到钱包，请安装 MetaMask。');
            }
            checkColorConflict();
        };

        window.ethereum?.on('chainChanged', () => window.location.reload());
        window.ethereum?.on('accountsChanged', (newAccounts) => {
            accounts = newAccounts;
            if (newAccounts.length === 0) {
                showStatus('未连接');
                enableInputs(false);
            } else {
                connectWallet();
            }
        });
    </script>
</body>
</html>
